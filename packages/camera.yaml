####################################################
#                                                  #
#                      FFMPEG                      #
#                                                  #
####################################################
#https://www.home-assistant.io/integrations/ffmpeg/
ffmpeg:

####################################################
#                                                  #
#                     STREAM                       #
#                                                  #
####################################################
# Enable stream
# https://www.home-assistant.io/integrations/stream/
stream:

####################################################
#                                                  #
#                      CAMERA                      #
#                                                  #
####################################################
# https://www.home-assistant.io/integrations/camera/
#camera:
#    # https://www.home-assistant.io/integrations/generic_ip_camera/
#  - platform: generic
#    name: Kamera 1
#    still_image_url: !secret Camera_1_URL
#    stream_source: !secret Camera_1_Source

#  - platform: generic
#    name: Kamera 2
#    still_image_url: !secret Camera_2_URL
#    stream_source: !secret Camera_2_Source

camera:
  - platform: reolink_dev
    name: Kamera 1
    host: 192.168.1.20
    username: !secret Camera_User
    password: !secret Camera_Password
    scan_interval: 5
    filename: /config/kamera_1_images/snapshot_{{ entity_id }}

  - platform: reolink_dev
    name: Kamera 2
    host: 192.168.1.21
    username: !secret Camera_User
    password: !secret Camera_Password
    scan_interval: 5

binary_sensor:
  - platform: template
    sensors:
      motion_kamera_1:
        friendly_name: Motion Kamera 1
        device_class: motion
        entity_id: camera.kamera_1
        value_template: "{{ is_state('camera.kamera_1', 'motion') }}"
        delay_off: 
          seconds: 30

  - platform: template
    sensors:
      motion_kamera_2:
        friendly_name: Motion Kamera 2
        device_class: motion
        entity_id: camera.kamera_2
        value_template: "{{ is_state('camera.kamera_2', 'motion') }}"
        delay_off: 
          seconds: 30


#binary_sensor:
#  - platform: rest
#    resource: !secret Camera_1_Motion
#    name: Motion Kamera 1
#    scan_interval: 5
#    value_template: “{{ value_json[0].value.state }}”
#    device_class: motion

#  - platform: rest
#    resource: !secret Camera_2_Motion
#    name: Motion Kamera 2
#    scan_interval: 5
#    value_template: “{{ value_json[0].value.state }}”
#    device_class: motion

####################################################
#                                                  #
#                      TIMER                       #
#                                                  #
####################################################
# https://www.home-assistant.io/integrations/timer/
timer:
  # Timers för camera 1
  timer_camera_1:
    name: Tid kvar kamera 1
    duration: '00:03:00'

  # Timers för camera 2
  timer_camera_2:
    name: Tid kvar kamera 2
    duration: '00:03:00'

####################################################
#                                                  #
#                     INPUT_BOOLEAN                #
#                                                  #
####################################################
# https://www.home-assistant.io/integrations/input_boolean/
input_boolean:
  camera_1_aktiv:
    name: Kamera 1 aktiv
    initial: off

  camera_2_aktiv:
    name: Kamera 2 aktiv
    initial: off

  camera_1_and_2_aktiv:
    name: Kameror aktiva
    initial: off

automation:
    ###############################################
    ### Startar timer vid rörelse camera 1      ###
    ### T: binary_sensor.motion_kamera_1 == on  ###
    ###    binary_sensor.motion_kamera_1 == off ###
    ### A: input_boolean.camera_1_aktiv = on    ###
    ###    timer.timer_camera_1 = cancel        ###
    ###    timer.timer_camera_1 = start         ###
    ###############################################
  - alias: Startar Camera 1 timer
    trigger:
      - platform: state
        entity_id: binary_sensor.motion_kamera_1
        to: 'on'
      - platform: state
        entity_id: binary_sensor.motion_kamera_1
        to: 'off'
    action:
      # Aktiverar rorelsevakt_aktiv
      - service: input_boolean.turn_on
        data:
          entity_id: input_boolean.camera_1_aktiv

      # Cancel timer, återställer till maxtid
      - service: timer.cancel
        entity_id: timer.timer_camera_1

      # Start timer, börjar räkna ner tiden
      - service: timer.start
        entity_id: timer.timer_camera_1

    ###############################################
    ### Startar timer vid rörelse camera 2      ###
    ### T: binary_sensor.motion_kamera_1 == on  ###
    ###    binary_sensor.motion_kamera_1 == off ###
    ### A: input_boolean.camera_2_aktiv = on    ###
    ###    timer.timer_camera_2 = cancel        ###
    ###    timer.timer_camera_2 = start         ###
    ###############################################
  - alias: Startar Camera 2 timer
    trigger:
      - platform: state
        entity_id: binary_sensor.motion_kamera_2
        to: 'on'
      - platform: state
        entity_id: binary_sensor.motion_kamera_2
        to: 'off'
    action:
      # Aktiverar rorelsevakt_aktiv
      - service: input_boolean.turn_on
        data:
          entity_id: input_boolean.camera_2_aktiv

      # Cancel timer, återställer till maxtid
      - service: timer.cancel
        entity_id: timer.timer_camera_2

      # Start timer, börjar räkna ner tiden
      - service: timer.start
        entity_id: timer.timer_camera_2

    ###############################################
    ### Stänger av camera_1_aktiv               ###
    ### T: timer.timer_camera_1 == finished     ###
    ### C: group.track_for_home_devices == away ###
    ###    input_boolean.camera_1_aktiv == on   ###
    ### A: input_boolean.camera_1_aktiv = off   ###
    ###############################################
  - alias: Stänger av camera_1_aktiv
    trigger:
      - platform: event
        event_type: timer.finished
        event_data:
          entity_id: timer.timer_camera_1
    condition:
      condition: and
      conditions:
        - condition: state
          entity_id:  input_boolean.camera_1_aktiv
          state: 'on'
    action:
      - service: input_boolean.turn_off
        data:
          entity_id: input_boolean.camera_1_aktiv

    ###############################################
    ### Stänger av camera_2_aktiv               ###
    ### T: timer.timer_camera_2 == finished     ###
    ### C: group.track_for_home_devices == home ###
    ###    input_boolean.camera_2_aktiv == on   ###
    ### A: input_boolean.camera_2_aktiv = off   ###
    ###############################################
  - alias: Stänger av camera_2_aktiv
    trigger:
      - platform: event
        event_type: timer.finished
        event_data:
          entity_id: timer.timer_camera_2
    condition:
      condition: and
      conditions:
        - condition: state
          entity_id:  input_boolean.camera_2_aktiv
          state: 'on'
    action:
      - service: input_boolean.turn_off
        data:
          entity_id: input_boolean.camera_2_aktiv

    ##################################################
    ### Startar camera_1_and_2_aktiv               ###
    ### T: input_boolean.camera_1_aktiv == on      ###
    ### C: input_boolean.camera_2_aktiv == on      ###
    ### A: input_boolean.camera_1_and_2_aktiv = on ###
    ##################################################
  - alias: Startar camera_1_and_2_aktiv (1 aktiv) 
    trigger:
      - platform: state
        entity_id: input_boolean.camera_1_aktiv
        to: 'on'
    condition:
      condition: and
      conditions:
        - condition: state
          entity_id:  input_boolean.camera_2_aktiv
          state: 'on'
    action:
      - service: input_boolean.turn_on
        data:
          entity_id: input_boolean.camera_1_and_2_aktiv

    ##################################################
    ### Startar camera_1_and_2_aktiv               ###
    ### T: input_boolean.camera_2_aktiv == on      ###
    ### C: input_boolean.camera_1_aktiv == on      ###
    ### A: input_boolean.camera_1_and_2_aktiv = on ###
    ##################################################
  - alias: Startar camera_1_and_2_aktiv (2 aktiv) 
    trigger:
      - platform: state
        entity_id: input_boolean.camera_2_aktiv
        to: 'on'
    condition:
      condition: and
      conditions:
        - condition: state
          entity_id:  input_boolean.camera_1_aktiv
          state: 'on'
    action:
      - service: input_boolean.turn_on
        data:
          entity_id: input_boolean.camera_1_and_2_aktiv

    ###################################################
    ### Stoppar camera_1_and_2_aktiv                ###
    ### T: input_boolean.camera_1_aktiv == off      ###
    ### C: input_boolean.camera_2_aktiv == off      ###
    ### A: input_boolean.camera_1_and_2_aktiv = off ###
    ###################################################
  - alias: Stoppar camera_1_and_2_aktiv (1 inaktiv) 
    trigger:
      - platform: state
        entity_id: input_boolean.camera_1_aktiv
        to: 'off'
    condition:
      condition: and
      conditions:
        - condition: state
          entity_id:  input_boolean.camera_2_aktiv
          state: 'off'
    action:
      - service: input_boolean.turn_off
        data:
          entity_id: input_boolean.camera_1_and_2_aktiv

    ###################################################
    ### Stoppar camera_1_and_2_aktiv                ###
    ### T: input_boolean.camera_2_aktiv == off      ###
    ### C: input_boolean.camera_1_aktiv == off      ###
    ### A: input_boolean.camera_1_and_2_aktiv = off ###
    ###################################################
  - alias: Stoppar camera_1_and_2_aktiv (2 inaktiv) 
    trigger:
      - platform: state
        entity_id: input_boolean.camera_2_aktiv
        to: 'off'
    condition:
      condition: and
      conditions:
        - condition: state
          entity_id:  input_boolean.camera_1_aktiv
          state: 'off'
    action:
      - service: input_boolean.turn_off
        data:
          entity_id: input_boolean.camera_1_and_2_aktiv

    #####################################################
    ### Skickar notification om kamera 1 aktiv, hemma ###
    ### T: input_boolean.camera_1_aktiv == on         ###
    ### C: group.track_for_home_devices == home       ###
    ### A: notify                                     ###
    #####################################################
  - alias: Larm kamera 1 aktiv (home)
    trigger:
      platform: state
      entity_id: input_boolean.camera_1_aktiv
      to: 'on'
    condition:
      condition: and
      conditions:
        - condition: state
          entity_id: group.track_for_home_devices
          state: 'home'
    action:
      - service: notify.pushbullet
        data:
          message: 'LARM! Kamera 1 aktiv'

    #####################################################
    ### Skickar notification om kamera 2 aktiv, hemma ###
    ### T: input_boolean.camera_2_aktiv == on         ###
    ### C: group.track_for_home_devices == home       ###
    ### A: notify                                     ###
    #####################################################
  - alias: Larm kamera 2 aktiv (home)
    trigger:
      platform: state
      entity_id: input_boolean.camera_2_aktiv
      to: 'on'
    condition:
      condition: and
      conditions:
        - condition: state
          entity_id: group.track_for_home_devices
          state: 'home'
    action:
      - service: notify.pushbullet
        data:
          message: 'LARM! Kamera 2 aktiv'

    #####################################################
    ### Skickar notification om kamera 1 aktiv, borta ###
    ### T: input_boolean.camera_1_aktiv == on         ###
    ### C: group.track_for_home_devices == not_home   ###
    ### A: notify                                     ###
    #####################################################
  - alias: Larm kamera 1 aktiv (away)
    trigger:
      platform: state
      entity_id: input_boolean.camera_1_aktiv
      to: 'on'
    condition:
      condition: and
      conditions:
        - condition: state
          entity_id: group.track_for_home_devices
          state: 'not_home'
    action:
      - service: notify.pushbullet
        data:
          message: 'LARM! Kamera 1 aktiv, ingen är hemma'

    #####################################################
    ### Skickar notification om kamera 2 aktiv, borta ###
    ### T: input_boolean.camera_2_aktiv == on         ###
    ### C: group.track_for_home_devices == not_home  ###
    ### A: notify                                     ###
    #####################################################
  - alias: Larm kamera 2 aktiv (away)
    trigger:
      platform: state
      entity_id: input_boolean.camera_2_aktiv
      to: 'on'
    condition:
      condition: and
      conditions:
        - condition: state
          entity_id: group.track_for_home_devices
          state: 'not_home'
    action:
      - service: notify.pushbullet
        data:
          message: 'LARM! Kamera 2 aktiv, ingen är hemma'

    ########################################################
    ### Skickar notification om kameror är aktiva, hemma ###
    ### T: input_boolean.camera_1_and_2_aktiv == on      ###
    ### C: group.track_for_home_devices == home          ###
    ### A: notify                                        ###
    ########################################################
  - alias: Larm kameror är aktiva (home)
    trigger:
      platform: state
      entity_id: input_boolean.camera_1_and_2_aktiv
      to: 'on'
    condition:
      condition: and
      conditions:
        - condition: state
          entity_id: group.track_for_home_devices
          state: 'home'
    action:
      - service: notify.pushbullet
        data:
          message: 'LARM! Kameror är aktiva'

    ########################################################
    ### Skickar notification om kameror är aktiva, borta ###
    ### T: input_boolean.camera_1_and_2_aktiv == on      ###
    ### C: group.track_for_home_devices == not_home      ###
    ### A: notify                                        ###
    ########################################################
  - alias: Larm kameror är aktiva (away)
    trigger:
      platform: state
      entity_id: input_boolean.camera_1_and_2_aktiv
      to: 'on'
    condition:
      condition: and
      conditions:
        - condition: state
          entity_id: group.track_for_home_devices
          state: 'not_home'
    action:
      - service: notify.pushbullet
        data:
          message: 'LARM! Kameror är aktiva, ingen är hemma'