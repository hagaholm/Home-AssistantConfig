####################################################
#                                                  #
#                      FFMPEG                      #
#                                                  #
####################################################
#https://www.home-assistant.io/integrations/ffmpeg/
ffmpeg:

####################################################
#                                                  #
#                     STREAM                       #
#                                                  #
####################################################
# Enable stream
# https://www.home-assistant.io/integrations/stream/
stream:

####################################################
#                                                  #
#                      CAMERA                      #
#                                                  #
####################################################
#camera:
#  - platform: reolink_dev
#    name: Kamera 1
#    host: 192.168.1.20
#    username: !secret Camera_User
#    password: !secret Camera_Password
#    scan_interval: 5

#  - platform: reolink_dev
#    name: Kamera 2
#    host: 192.168.1.21
#    username: !secret Camera_User
#    password: !secret Camera_Password
#    scan_interval: 5

#  - platform: reolink_dev
#    name: Kamera 3
#    host: 192.168.1.22
#    username: !secret Camera_User
#    password: !secret Camera_Password
#    scan_interval: 5

#  - platform: reolink_dev
#    name: Kamera 4
#    host: 192.168.1.34
#    username: !secret Camera_User
#    password: !secret Camera_Password
#    scan_interval: 5


####################################################
#                                                  #
#                    COMMAND_LINES                 #
#                                                  #
####################################################
command_line:
  - sensor:
      name: Deepstack photo files
      command: "ls -l /config/camera/deepstack_photo | wc -l"
      value_template: "{{ (value - 1) | round(0) }}"
  - sensor:
      name: Motion detected photo files
      command: "ls -l /config/camera/motion_detected | wc -l"
      value_template: "{{ (value - 1) | round(0) }}"
  - sensor:
      name: Camera animal files
      command: "ls -l /media/0/animal | wc -l"
      value_template: "{{ (value - 1) | round(0) }}"
  - sensor:
      name: Camera day files
      command: "ls -l /media/0/Day | wc -l"
      value_template: "{{ (value - 1) | round(0) }}"
  - sensor:
      name: Camera night files
      command: "ls -l /media/0/Night | wc -l"
      value_template: "{{ (value - 1) | round(0) }}"
  - sensor:
      name: Camera away files
      command: "ls -l /media/0/Away | wc -l"
      value_template: "{{ (value - 1) | round(0) }}"
  - sensor:
      name: Camera video away files
      command: "ls -l /media/0/video_Away | wc -l"
      value_template: "{{ (value - 1) | round(0) }}"
  - sensor:
      name: Camera video night files
      command: "ls -l /media/0/video_Night | wc -l"
      value_template: "{{ (value - 1) | round(0) }}"

####################################################
#                                                  #
#                    INPUT_SELECT                  #
#                                                  #
####################################################
input_select:
  camera_mode:
    name: Kamera mode
    icon: mdi:video-outline
    options:
     - Off   # Off
     - Day   # Info
     - Night # Warning
     - Away  # Warning

####################################################
#                                                  #
#                    INPUT_NUMBER                  #
#                                                  #
####################################################
input_number:
  # Used for control the delay time between image processing
  camera_duration:
    name: Kamera väntetid mellan bild analys
    initial: 500
    min: 0
    max: 1000
    step: 100

####################################################
#                                                  #
#                        TIMER                     #
#                                                  #
####################################################
timer:
  # Used for control the delay time between image processing
  timer_camera_motion_detected:
    name: Timer camera motion detected
    duration: '00:00:30'

##################
### Automation ###
##################
automation:
  #################################
  ### Activate camera mode Away ###
  #################################
  - alias: Camera mode Away
    trigger:
      - platform: state
        entity_id: input_select.home_status
        to: 'Borta'

    action:
      - service: input_select.select_option
        data:
          entity_id: input_select.camera_mode
          option: Away

  ################################
  ### Activate camera mode Day ###
  ################################
  - alias: Camera mode Day
    trigger:
      - platform: state
        entity_id: input_select.home_status
        to: 'Hemma på'

    action:
      - service: input_select.select_option
        data:
          entity_id: input_select.camera_mode
          option: Day

  ##################################
  ### Activate camera mode Night ###
  ##################################
  - alias: Camera mode Night
    trigger:
      platform: state
      entity_id: input_select.home_status
      to: "Hemma av"

    action:
      - service: input_select.select_option
        data:
          entity_id: input_select.camera_mode
          option: Night

  #########################
  ### Delete old images ###
  #########################
  - alias: Camera move images
    trigger:
      - platform: time
        at: "00:00:01" # HH:MM:SS

    action:
      - service: shell_command.move_camera_files_9a
      - service: shell_command.move_camera_files_9b
      - service: shell_command.move_camera_files_9c
      - service: shell_command.move_camera_files_9d
      - service: shell_command.move_camera_files_9e
      - service: shell_command.move_camera_files_9f
      - service: shell_command.move_camera_files_8a
      - service: shell_command.move_camera_files_8b
      - service: shell_command.move_camera_files_8c
      - service: shell_command.move_camera_files_8d
      - service: shell_command.move_camera_files_8e
      - service: shell_command.move_camera_files_8f
      - service: shell_command.move_camera_files_7a
      - service: shell_command.move_camera_files_7b
      - service: shell_command.move_camera_files_7c
      - service: shell_command.move_camera_files_7d
      - service: shell_command.move_camera_files_7e
      - service: shell_command.move_camera_files_7f
      - service: shell_command.move_camera_files_6a
      - service: shell_command.move_camera_files_6b
      - service: shell_command.move_camera_files_6c
      - service: shell_command.move_camera_files_6d
      - service: shell_command.move_camera_files_6e
      - service: shell_command.move_camera_files_6f
      - service: shell_command.move_camera_files_5a
      - service: shell_command.move_camera_files_5b
      - service: shell_command.move_camera_files_5c
      - service: shell_command.move_camera_files_5d
      - service: shell_command.move_camera_files_5e
      - service: shell_command.move_camera_files_5f
      - service: shell_command.move_camera_files_4a
      - service: shell_command.move_camera_files_4b
      - service: shell_command.move_camera_files_4c
      - service: shell_command.move_camera_files_4d
      - service: shell_command.move_camera_files_4e
      - service: shell_command.move_camera_files_4f
      - service: shell_command.move_camera_files_3a
      - service: shell_command.move_camera_files_3b
      - service: shell_command.move_camera_files_3c
      - service: shell_command.move_camera_files_3d
      - service: shell_command.move_camera_files_3e
      - service: shell_command.move_camera_files_3f
      - service: shell_command.move_camera_files_2a
      - service: shell_command.move_camera_files_2b
      - service: shell_command.move_camera_files_2c
      - service: shell_command.move_camera_files_2d
      - service: shell_command.move_camera_files_2e
      - service: shell_command.move_camera_files_2f
      - service: shell_command.move_camera_files_1a
      - service: shell_command.move_camera_files_1b
      - service: shell_command.move_camera_files_1c
      - service: shell_command.move_camera_files_1d
      - service: shell_command.move_camera_files_1e
      - service: shell_command.move_camera_files_1f
      - service: shell_command.move_camera_files_0a
      - service: shell_command.move_camera_files_0b
      - service: shell_command.move_camera_files_0c
      - service: shell_command.move_camera_files_0d
      - service: shell_command.move_camera_files_0e
      - service: shell_command.move_camera_files_0f

  #######################################
  ### Camera Motion Set duration time ###
  #######################################
  - alias: Camera Motion Set duration time
    mode: restart

    trigger:
      - platform: event
        event_type: deepstack.object_detected

   # Need to be a person on the image from camera 3
    condition:
      condition: and
      conditions:

        # Person on image is needed
        - condition: template
          value_template: >
            {{ trigger.event.data.object_type == 'person' }}

    action:
      - service: input_number.set_value
        data_template:
          entity_id: input_number.camera_duration
          value: 0

      # Cancel timer and reset to max time
      - service: timer.cancel
        entity_id: timer.timer_camera_motion_detected

      # Start timer and count down
      - service: timer.start
        entity_id: timer.timer_camera_motion_detected

  #########################################
  ### Camera Motion Reset duration time ###
  #########################################
  - alias: Camera Motion Reset duration time
    trigger:
      # Timer finished after 30 sec
      - platform: event
        event_type: timer.finished
        event_data:
          entity_id: timer.timer_camera_motion_detected
 
    action:
      - service: input_number.set_value
        data_template:
          entity_id: input_number.camera_duration
          value: 500


  - alias: Cpu temp below 58.0
    trigger:
      platform: numeric_state
      entity_id: sensor.cpu_temperature
      below: '58.0'

    condition:
      condition: and
      conditions:
        - condition: numeric_state
          entity_id: input_number.camera_duration
          above: '0'

    action:
      - service: input_number.set_value
        data_template:
          entity_id: input_number.camera_duration
          value: 500

  - alias: Cpu temp 58.0
    trigger:
      platform: numeric_state
      entity_id: sensor.cpu_temperature
      below: '58.1'
      above: '57.9'

    condition:
      condition: and
      conditions:
        - condition: numeric_state
          entity_id: input_number.camera_duration
          above: '0'

    action:
      - service: input_number.set_value
        data_template:
          entity_id: input_number.camera_duration
          value: 600

  - alias: Cpu temp 58.5
    trigger:
      platform: numeric_state
      entity_id: sensor.cpu_temperature
      below: '58.6'
      above: '58.4'

    condition:
      condition: and
      conditions:
        - condition: numeric_state
          entity_id: input_number.camera_duration
          above: '0'

    action:
      - service: input_number.set_value
        data_template:
          entity_id: input_number.camera_duration
          value: 700

  - alias: Cpu temp 59.0
    trigger:
      platform: numeric_state
      entity_id: sensor.cpu_temperature
      below: '59.1'
      above: '58.9'

    condition:
      condition: and
      conditions:
        - condition: numeric_state
          entity_id: input_number.camera_duration
          above: '0'

    action:
      - service: input_number.set_value
        data_template:
          entity_id: input_number.camera_duration
          value: 800

  - alias: Cpu temp 59.5
    trigger:
      platform: numeric_state
      entity_id: sensor.cpu_temperature
      below: '59.6'
      above: '59.4'

    condition:
      condition: and
      conditions:
        - condition: numeric_state
          entity_id: input_number.camera_duration
          above: '0'

    action:
      - service: input_number.set_value
        data_template:
          entity_id: input_number.camera_duration
          value: 900

  - alias: Cpu temp above 59.5
    trigger:
      platform: numeric_state
      entity_id: sensor.cpu_temperature
      above: '59.9'

    condition:
      condition: and
      conditions:
        - condition: numeric_state
          entity_id: input_number.camera_duration
          above: '0'

    action:
      - service: input_number.set_value
        data_template:
          entity_id: input_number.camera_duration
          value: 1000

##############
### Script ###
##############
script:
  # Delete all files, Used by user
  delete_camera_files:
    sequence:
      - service: shell_command.delete_camera_files_1
      - service: shell_command.delete_camera_files_2
      - service: shell_command.delete_camera_files_3
      - service: shell_command.delete_camera_files_4
      - service: shell_command.delete_camera_files_5
      - service: shell_command.delete_camera_files_6
      - service: shell_command.delete_camera_files_7
      - service: shell_command.delete_camera_files_8

  # Delete 5 days old files, Used by user
  delete_5_days_old_camera_files:
    sequence:
      - service: shell_command.delete_5_days_old_images_in_camera_deepstack_photo
      - service: shell_command.delete_5_days_old_images_in_camera_motion_detected
      - service: shell_command.delete_5_days_old_images_in_media_animal
      - service: shell_command.delete_5_days_old_images_in_media_away
      - service: shell_command.delete_5_days_old_images_in_media_day
      - service: shell_command.delete_5_days_old_images_in_media_night
      - service: shell_command.delete_5_days_old_videos_in_media_video_away
      - service: shell_command.delete_5_days_old_videos_in_media_video_night

#####################
### Shell command ###
#####################
shell_command:
  # Delete 10 days old images from folders:
  delete_10_days_old_images_in_camera_deepstack_photo: 'find /config/camera/deepstack_photo -mtime +10 -type f -delete' 
  delete_10_days_old_images_in_camera_motion_detected: 'find /config/camera/motion_detected -mtime +10 -type f -delete' 
  delete_10_days_old_images_in_media_animal: 'find /media/animal -mtime +10 -type f -delete' 
  delete_10_days_old_images_in_media_away: 'find /media/Away -mtime +10 -type f -delete' 
  delete_10_days_old_images_in_media_day: 'find /media/Day -mtime +10 -type f -delete' 
  delete_10_days_old_images_in_media_night: 'find /media/Night -mtime +10 -type f -delete' 

  # Delete 10 days old videos from folders:
  delete_10_days_old_videos_in_media_video_away: 'find /media/video/Away -mtime +10 -type f -delete' 
  delete_10_days_old_videos_in_media_video_night: 'find /media/video/Night -mtime +10 -type f -delete' 

  # Delete 5 days old images from folders:
  delete_5_days_old_images_in_camera_deepstack_photo: 'find /config/camera/deepstack_photo -mtime +5 -type f -delete' 
  delete_5_days_old_images_in_camera_motion_detected: 'find /config/camera/motion_detected -mtime +5 -type f -delete' 
  delete_5_days_old_images_in_media_animal: 'find /media/animal -mtime +5 -type f -delete' 
  delete_5_days_old_images_in_media_away: 'find /media/Away -mtime +5 -type f -delete' 
  delete_5_days_old_images_in_media_day: 'find /media/Day -mtime +5 -type f -delete' 
  delete_5_days_old_images_in_media_night: 'find /media/Night -mtime +5 -type f -delete' 

  # Delete 5 days old videos from folders:
  delete_5_days_old_videos_in_media_video_away: 'find /media/video/Away -mtime +5 -type f -delete' 
  delete_5_days_old_videos_in_media_video_night: 'find /media/video/Night -mtime +5 -type f -delete' 

  # Used by script delete_camera_files
  delete_camera_files_1: 'rm -f /config/camera/deepstack_photo/*'
  delete_camera_files_2: 'rm -f /config/camera/motion_detected/*'
  delete_camera_files_3: 'rm -f /media/animal/*'
  delete_camera_files_4: 'rm -f /media/Away/*'
  delete_camera_files_5: 'rm -f /media/Day/*'
  delete_camera_files_6: 'rm -f /media/Night/*'
  delete_camera_files_7: 'rm -f /media/video/Away/*'
  delete_camera_files_8: 'rm -f /media/video/Night/*'

  # Used by script move_camera_files
  move_camera_files_9a: 'rm -f /media/9/animal/*'
  move_camera_files_9b: 'rm -f /media/9/Away/*'
  move_camera_files_9c: 'rm -f /media/9/Day/*'
  move_camera_files_9d: 'rm -f /media/9/Night/*'
  move_camera_files_9e: 'rm -f /media/9/video_Away/*'
  move_camera_files_9f: 'rm -f /media/9/video_Night/*'
  move_camera_files_8a: 'mv -f /media/8/animal/* /media/9/animal/'
  move_camera_files_8b: 'mv -f /media/8/Away/* /media/9/Away/'
  move_camera_files_8c: 'mv -f /media/8/Day/* /media/9/Day/'
  move_camera_files_8d: 'mv -f /media/8/Night/* /media/9/Night/'
  move_camera_files_8e: 'mv -f /media/8/video_Away/* /media/9/video_Away/'
  move_camera_files_8f: 'mv -f /media/8/video_Night/* /media/9/video_Night/'
  move_camera_files_7a: 'mv -f /media/7/animal/* /media/8/animal/'
  move_camera_files_7b: 'mv -f /media/7/Away/* /media/8/Away/'
  move_camera_files_7c: 'mv -f /media/7/Day/* /media/8/Day/'
  move_camera_files_7d: 'mv -f /media/7/Night/* /media/8/Night/'
  move_camera_files_7e: 'mv -f /media/7/video_Away/* /media/8/video_Away/'
  move_camera_files_7f: 'mv -f /media/7/video_Night/* /media/8/video_Night/'
  move_camera_files_6a: 'mv -f /media/6/animal/* /media/7/animal/'
  move_camera_files_6b: 'mv -f /media/6/Away/* /media/7/Away/'
  move_camera_files_6c: 'mv -f /media/6/Day/* /media/7/Day/'
  move_camera_files_6d: 'mv -f /media/6/Night/* /media/7/Night/'
  move_camera_files_6e: 'mv -f /media/6/video_Away/* /media/7/video_Away/'
  move_camera_files_6f: 'mv -f /media/6/video_Night/* /media/7/video_Night/'
  move_camera_files_5a: 'mv -f /media/5/animal/* /media/6/animal/'
  move_camera_files_5b: 'mv -f /media/5/Away/* /media/6/Away/'
  move_camera_files_5c: 'mv -f /media/5/Day/* /media/6/Day/'
  move_camera_files_5d: 'mv -f /media/5/Night/* /media/6/Night/'
  move_camera_files_5e: 'mv -f /media/5/video_Away/* /media/6/video_Away/'
  move_camera_files_5f: 'mv -f /media/5/video_Night/* /media/6/video_Night/'
  move_camera_files_4a: 'mv -f /media/4/animal/* /media/5/animal/'
  move_camera_files_4b: 'mv -f /media/4/Away/* /media/5/Away/'
  move_camera_files_4c: 'mv -f /media/4/Day/* /media/5/Day/'
  move_camera_files_4d: 'mv -f /media/4/Night/* /media/5/Night/'
  move_camera_files_4e: 'mv -f /media/4/video_Away/* /media/5/video_Away/'
  move_camera_files_4f: 'mv -f /media/4/video_Night/* /media/5/video_Night/'
  move_camera_files_3a: 'mv -f /media/3/animal/* /media/4/animal/'
  move_camera_files_3b: 'mv -f /media/3/Away/* /media/4/Away/'
  move_camera_files_3c: 'mv -f /media/3/Day/* /media/4/Day/'
  move_camera_files_3d: 'mv -f /media/3/Night/* /media/4/Night/'
  move_camera_files_3e: 'mv -f /media/3/video_Away/* /media/4/video_Away/'
  move_camera_files_3f: 'mv -f /media/3/video_Night/* /media/4/video_Night/'
  move_camera_files_2a: 'mv -f /media/2/animal/* /media/3/animal/'
  move_camera_files_2b: 'mv -f /media/2/Away/* /media/3/Away/'
  move_camera_files_2c: 'mv -f /media/2/Day/* /media/3/Day/'
  move_camera_files_2d: 'mv -f /media/2/Night/* /media/3/Night/'
  move_camera_files_2e: 'mv -f /media/2/video_Away/* /media/3/video_Away/'
  move_camera_files_2f: 'mv -f /media/2/video_Night/* /media/3/video_Night/'
  move_camera_files_1a: 'mv -f /media/1/animal/* /media/2/animal/'
  move_camera_files_1b: 'mv -f /media/1/Away/* /media/2/Away/'
  move_camera_files_1c: 'mv -f /media/1/Day/* /media/2/Day/'
  move_camera_files_1d: 'mv -f /media/1/Night/* /media/2/Night/'
  move_camera_files_1e: 'mv -f /media/1/video_Away/* /media/2/video_Away/'
  move_camera_files_1f: 'mv -f /media/1/video_Night/* /media/2/video_Night/'
  move_camera_files_0a: 'mv -f /media/0/animal/* /media/1/animal/'
  move_camera_files_0b: 'mv -f /media/0/Away/* /media/1/away/'
  move_camera_files_0c: 'mv -f /media/0/Day/* /media/1/Day/'
  move_camera_files_0d: 'mv -f /media/0/Night/* /media/1/Night/'
  move_camera_files_0e: 'mv -f /media/0/video_Away/* /media/1/video_Away/'
  move_camera_files_0f: 'mv -f /media/0/video_Night/* /media/1/video_Night/'

